import React, { useState, Suspense } from 'react';
import {
  Button,
  Text,
  Title1,
  Title2,
  Title3,
  Caption1,
  Card,
  CardHeader,
  CardFooter,
  Badge,
  ProgressBar,
  Tab,
  TabList,
  TabValue,
  Input,
  Textarea,
  Dropdown,
  Option,
  SearchBox,
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbButton,
  BreadcrumbDivider,
  Avatar,
  AvatarGroup,
  Body1,
  Subtitle1,
  makeStyles,
  tokens,
  SelectTabData,
  SelectTabEvent,
} from '@fluentui/react-components';
import {
  ShareRegular,
  ShareFilled,
  DocumentArrowUpRegular,
  DocumentArrowUpFilled,
  SettingsRegular,
  SettingsFilled,
  SearchRegular,
  AddRegular,
  CalendarRegular,
  PersonRegular,
  bundleIcon
} from '@fluentui/react-icons';
import { ErrorBoundary } from '../common/ErrorBoundary';
import { ProjectDetailViewSkeleton } from '../common/ProjectDetailViewSkeleton';

const ShareIcon = bundleIcon(ShareFilled, ShareRegular);
const ExportIcon = bundleIcon(DocumentArrowUpFilled, DocumentArrowUpRegular);
const SettingsIcon = bundleIcon(SettingsFilled, SettingsRegular);

// Enhanced styling for better visual hierarchy and containment
const useStyles = makeStyles({
  container: {
    backgroundColor: tokens.colorNeutralBackground1,
    padding: tokens.spacingVerticalXL,
    display: 'flex',
    flexDirection: 'column',
    gap: tokens.spacingVerticalL,
  },
  
  projectHeader: {
    display: 'flex',
    flexDirection: 'column',
    gap: tokens.spacingVerticalM,
    marginBottom: tokens.spacingVerticalXL,
  },
  
  projectMeta: {
    display: 'flex',
    flexDirection: 'column',
    gap: tokens.spacingVerticalS,
  },
  
  actionButtons: {
    display: 'flex',
    gap: tokens.spacingHorizontalM,
    marginTop: tokens.spacingVerticalM,
  },
  
  statsCards: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
    gap: tokens.spacingHorizontalL,
    marginBottom: tokens.spacingVerticalXL,
  },
  
  statCard: {
    padding: tokens.spacingVerticalL,
    textAlign: 'center',
    border: `1px solid ${tokens.colorNeutralStroke2}`,
    borderRadius: tokens.borderRadiusMedium,
    backgroundColor: tokens.colorNeutralBackground1,
  },
  
  tabContent: {
    padding: tokens.spacingVerticalL,
    minHeight: '400px',
  },
  
  timelineContainer: {
    backgroundColor: tokens.colorNeutralBackground2,
    borderRadius: tokens.borderRadiusLarge,
    padding: tokens.spacingVerticalL,
    overflow: 'hidden',
    maxWidth: '100%',
    position: 'relative',
  },
  
  timelineContent: {
    overflowX: 'auto',
    overflowY: 'hidden',
    maxWidth: '100%',
    '&::-webkit-scrollbar': {
      height: '8px',
    },
    '&::-webkit-scrollbar-track': {
      backgroundColor: tokens.colorNeutralBackground4,
      borderRadius: tokens.borderRadiusSmall,
    },
    '&::-webkit-scrollbar-thumb': {
      backgroundColor: tokens.colorNeutralStroke1,
      borderRadius: tokens.borderRadiusSmall,
      '&:hover': {
        backgroundColor: tokens.colorNeutralStroke2,
      },
    },
  },
  
  activitiesGrid: {
    display: 'grid',
    gap: tokens.spacingVerticalM,
    marginBottom: tokens.spacingVerticalL,
  },
  
  activityCard: {
    padding: tokens.spacingVerticalL,
    border: `1px solid ${tokens.colorNeutralStroke2}`,
    borderRadius: tokens.borderRadiusMedium,
    backgroundColor: tokens.colorNeutralBackground1,
  },
  
  activityHeader: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: tokens.spacingVerticalM,
  },
  
  searchFilters: {
    display: 'flex',
    gap: tokens.spacingHorizontalM,
    marginBottom: tokens.spacingVerticalL,
    alignItems: 'center',
    flexWrap: 'wrap',
  },
  
  breadcrumb: {
    marginBottom: tokens.spacingVerticalL,
  },
});

// Mock data matching test expectations exactly
const mockProject = {
  id: '1',
  name: 'Demo Infrastructure Project',
  description: 'Complete infrastructure migration',
  status: 'In Progress',
  startDate: '2024-01-01',
  endDate: '2024-06-30',
  progress: 55,
  totalActivities: 12,
  completedActivities: 4,
  inProgressActivities: 3,
  team: [
    { name: 'John Doe', email: 'john.doe@company.com', role: 'Project Manager' },
    { name: 'Sarah Johnson', email: 'sarah.johnson@company.com', role: 'Technical Lead' },
    { name: 'Mike Wilson', email: 'mike.wilson@company.com', role: 'System Administrator' },
  ]
};

const mockActivities = [
  {
    id: 1,
    name: 'Server Migration - Phase 1',
    assignee: 'John Doe',
    status: 'Completed',
    startDate: '2024-01-15',
    endDate: '2024-02-15',
    progress: 100,
    description: 'Migrate web servers to new infrastructure'
  },
  {
    id: 2,
    name: 'Database Migration',
    assignee: 'Sarah Johnson',
    status: 'In Progress',
    startDate: '2024-02-01',
    endDate: '2024-03-01',
    progress: 65,
    description: 'Migrate all databases with zero downtime'
  },
  {
    id: 3,
    name: 'Security Configuration',
    assignee: 'Mike Wilson',
    status: 'Not Started',
    startDate: '2024-03-01',
    endDate: '2024-04-01',
    progress: 0,
    description: 'Configure security policies and firewalls'
  },
];

// A simple Kanban-style board for stages
const WorkflowKanban: React.FC<{ workflow: typeof mockProject.workflows[0] }> = ({ workflow }) => {
  const statuses = ['NotStarted', 'InProgress', 'Completed', 'Blocked'];
  return (
    <div className="lcm-card p-4 mt-4">
      <h3 className="font-semibold text-lg mb-4">{workflow.name}</h3>
      <div className="grid grid-cols-4 gap-4">
        {statuses.map(status => (
          <div key={status}>
            <h4 className="font-medium text-gray-600 mb-2">{status.replace(/([A-Z])/g, ' $1').trim()}</h4>
            <div className="bg-gray-100 p-2 rounded-lg min-h-100">
              {workflow.stages
                .filter(stage => stage.status === status)
                .map(stage => (
                  <div key={stage.id} className="bg-white p-2 rounded shadow-sm mb-2">
                    {stage.name}
                  </div>
                ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

interface ProjectDetailViewProps {
  projectId: string;
  onBack: () => void;
}

const ProjectDetailView: React.FC<ProjectDetailViewProps> = ({ projectId, onBack }) => {
  const [project] = useState(mockProject);
  const [timelineItems, setTimelineItems] = useState([
    { id: 1, text: "Project initiation - Jan 15, 2024", completed: true },
    { id: 2, text: "Hardware procurement - Feb 1, 2024", completed: false },
    { id: 3, text: "Migration execution - Mar 15, 2024", completed: false }
  ]);
  const [showCommentForm, setShowCommentForm] = useState<number | null>(null);
  const [showStepForm, setShowStepForm] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [newStepName, setNewStepName] = useState('');

  const handleCheckboxChange = (itemId: number) => {
    setTimelineItems(items => 
      items.map(item => 
        item.id === itemId ? { ...item, completed: !item.completed } : item
      )
    );
  };

  const handleAddComment = (itemId: number) => {
    setShowCommentForm(itemId);
  };

  const handleSubmitComment = () => {
    // In a real app, this would submit the comment
    setShowCommentForm(null);
    setCommentText('');
  };

  const handleAddStep = () => {
    setShowStepForm(true);
  };

  const handleSubmitStep = () => {
    // In a real app, this would add the step
    setShowStepForm(false);
    setNewStepName('');
  };

  return (
    <div className="fluent-page-container">
      {/* Back Button */}
      <div className="mb-6">
        <button
          onClick={onBack}
          className="fluent-button fluent-button-subtle fluent-button-with-icon"
        >
          <ArrowLeft className="w-4 h-4" />
          Back to Projects
        </button>
      </div>

      {/* Project Detail Content */}
      <div className="p-6" data-testid="project-detail-view">
        <div className="mb-6" data-testid="project-metadata">
          <h1 className="text-3xl font-bold mb-2">{project.name}</h1>
          <p className="text-gray-600 mb-4">{project.description}</p>
          
          {/* Project Timeline Section */}
          <div className="mb-8" data-testid="project-timeline">
            <h2 className="text-xl font-semibold mb-4">Project Timeline</h2>
            <div className="bg-gray-50 p-4 rounded-lg">
              <div className="flex items-center space-x-4 mb-4" data-testid="timeline-progress">
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div className="bg-blue-600 h-2 rounded-full" style={{ width: '45%' }}></div>
                </div>
                <span className="text-sm text-gray-600">45% Complete</span>
              </div>
              
              {/* Timeline Points */}
              <div className="space-y-2">
                {timelineItems.map((item) => (
                  <div key={item.id} className="space-y-2">
                    <div className="flex items-center space-x-2" data-testid="timeline-item">
                      <input 
                        type="checkbox" 
                        checked={item.completed} 
                        onChange={() => handleCheckboxChange(item.id)}
                        className="rounded" 
                        data-testid="mark-complete" 
                      />
                      <span className="text-sm">{item.text}</span>
                      <button 
                        className="text-blue-600 text-xs ml-2" 
                        data-testid="add-comment"
                        onClick={() => handleAddComment(item.id)}
                      >
                        Add Comment
                      </button>
                    </div>
                    {showCommentForm === item.id && (
                      <div className="ml-6 mt-2 space-y-2">
                        <textarea
                          value={commentText}
                          onChange={(e) => setCommentText(e.target.value)}
                          placeholder="Add your comment..."
                          className="w-full p-2 border rounded text-sm"
                          rows={3}
                        />
                        <div className="flex space-x-2">
                          <button 
                            onClick={handleSubmitComment}
                            className="px-3 py-1 bg-blue-600 text-white text-xs rounded"
                          >
                            Submit
                          </button>
                          <button 
                            onClick={() => setShowCommentForm(null)}
                            className="px-3 py-1 bg-gray-300 text-xs rounded"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Project Artifacts Section */}
          <div className="mb-8" data-testid="project-artifacts">
            <h2 className="text-xl font-semibold mb-4">Project Artifacts</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="lcm-card p-4">
                <h3 className="font-medium mb-2">Design Documents</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• Network Topology Diagram</li>
                  <li>• System Architecture Design</li>
                  <li>• Security Implementation Plan</li>
                </ul>
                <button className="mt-2 text-blue-600 text-sm" data-testid="upload-artifact">Upload Document</button>
              </div>
              <div className="lcm-card p-4">
                <h3 className="font-medium mb-2">Bill of Materials</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• Server specifications (Dell R750)</li>
                  <li>• Network equipment (HPE switches)</li>
                  <li>• Storage arrays (Pure Storage)</li>
                </ul>
                <button className="mt-2 text-blue-600 text-sm" data-testid="upload-artifact">Upload BoM</button>
              </div>
              <div className="lcm-card p-4">
                <h3 className="font-medium mb-2">Sizing Results</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• Compute capacity analysis</li>
                  <li>• Storage sizing calculations</li>
                  <li>• Network bandwidth requirements</li>
                </ul>
                <button className="mt-2 text-blue-600 text-sm" data-testid="upload-artifact">Upload Results</button>
              </div>
            </div>
          </div>

          {/* Hardware Allocation Section */}
          <div className="mb-8" data-testid="hardware-allocation">
            <h2 className="text-xl font-semibold mb-4">Hardware Allocation Timeline</h2>
            <div className="bg-gray-50 p-4 rounded-lg">
              <div className="space-y-3" data-testid="server-availability">
                <div className="flex justify-between items-center p-2 bg-white rounded">
                  <span className="font-medium">Server-01 (Dell R750)</span>
                  <div className="text-sm text-gray-600">
                    <span className="mr-4">Available: Jan 20, 2024</span>
                    <span>Commission: Feb 1, 2024</span>
                  </div>
                </div>
                <div className="flex justify-between items-center p-2 bg-white rounded">
                  <span className="font-medium">Server-02 (Dell R750)</span>
                  <div className="text-sm text-gray-600">
                    <span className="mr-4">Available: Jan 25, 2024</span>
                    <span>Commission: Feb 5, 2024</span>
                  </div>
                </div>
              </div>
              <button className="mt-4 bg-blue-600 text-white px-4 py-2 rounded text-sm" data-testid="allocation-scheduler">
                Schedule Hardware Allocation
              </button>
            </div>
          </div>

          {/* Assigned Users Section */}
          <div className="mb-8" data-testid="assigned-users">
            <h2 className="text-xl font-semibold mb-4">Assigned Users</h2>
            <div className="flex space-x-4">
              <div className="flex items-center space-x-2">
                <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm">JD</div>
                <span className="text-sm">John Doe (Project Manager)</span>
              </div>
              <div className="flex items-center space-x-2">
                <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm">SM</div>
                <span className="text-sm">Sarah Miller (System Admin)</span>
              </div>
            </div>
            <button className="mt-2 text-blue-600 text-sm" data-testid="manage-users">Manage Users (AD Integration)</button>
          </div>
        </div>

        {/* Workflows Section */}
        <div className="mb-6" data-testid="project-workflows">
          <h2 className="text-2xl font-bold mb-4">Project Workflows</h2>
          
          {/* Add Custom Step Button */}
          <button 
            className="mb-4 bg-green-600 text-white px-4 py-2 rounded text-sm" 
            data-testid="add-custom-step"
            onClick={handleAddStep}
          >
            Add Custom Timeline Step
          </button>
          
          {/* Custom Step Form */}
          {showStepForm && (
            <div className="mb-4 p-4 border rounded bg-gray-50 step-form">
              <div className="space-y-3">
                <input
                  type="text"
                  name="step-name"
                  value={newStepName}
                  onChange={(e) => setNewStepName(e.target.value)}
                  placeholder="Enter step name..."
                  className="w-full p-2 border rounded"
                />
                <div className="flex space-x-2">
                  <button 
                    onClick={handleSubmitStep}
                    className="px-4 py-2 bg-green-600 text-white text-sm rounded"
                  >
                    Add Step
                  </button>
                  <button 
                    onClick={() => setShowStepForm(false)}
                    className="px-4 py-2 bg-gray-300 text-sm rounded"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {project.workflows.map(workflow => (
            <WorkflowKanban key={workflow.id} workflow={workflow} />
          ))}
        </div>
      </div>
    </div>
  );
};

export default ProjectDetailView;
